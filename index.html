

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to Write and Debug C Extension Modules &mdash; c-extension-tutorial  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="c-extension-tutorial  documentation" href="#"/>
        <link rel="next" title="What is an Extension Module?" href="what-is-an-extension-module.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="#" class="icon icon-home"> c-extension-tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="what-is-an-extension-module.html">What is an Extension Module?</a></li>
<li class="toctree-l1"><a class="reference internal" href="c-level-representation.html">C Level Representation of Python Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing-a-function.html">Writing a New Function in C</a></li>
<li class="toctree-l1"><a class="reference internal" href="building-and-importing.html">Building and Importing</a></li>
<li class="toctree-l1"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="abstract-api.html">Abstract Object API</a></li>
<li class="toctree-l1"><a class="reference internal" href="fancy-argument-parsing.html">Fancy Argument Parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing-a-class.html">Writing a New Class in C</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-issues.html">Common Issues and Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="gdb.html">Debugging with GDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="member-vs-getset.html"><code class="docutils literal"><span class="pre">PyMemberDef</span></code> vs <code class="docutils literal"><span class="pre">PyGetSetDef</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">c-extension-tutorial</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>How to Write and Debug C Extension Modules</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-write-and-debug-c-extension-modules">
<h1>How to Write and Debug C Extension Modules<a class="headerlink" href="#how-to-write-and-debug-c-extension-modules" title="Permalink to this headline">¶</a></h1>
<p>The CPython interpreter allows us implement modules in C for performance
critical code or to interface with external libraries while presenting users
with a high level Python API. This tutorial will teach you how to leverage the
power of C in your Python projects.</p>
<p>We will start by explaining the C representation of Python objects and how to
manipulate them from within C. We will then move on to implementing functions in
C for use in Python. We will discuss reference counting and correct exception
handling. We will also talk about how to package and build your new extension
module so that it may be shared on PyPI. (We will only be covering building
extension modules on GNU/Linux and OSX, not Windows).</p>
<p>After the break, we will show how to implement a new type in C. This will cover
how to hook into various protocols and properly support cyclic garbage
collection. We will also discuss techniques for debugging C extension modules
with gdb using the CPython gdb extension.</p>
<div class="section" id="install-steps">
<h2>Install Steps<a class="headerlink" href="#install-steps" title="Permalink to this headline">¶</a></h2>
<p>Prior to the tutorial, attendees need to install a git, a C89 compatible C
compiler and gdb. OSX users will also need to install <code class="docutils literal"><span class="pre">brew</span></code>.</p>
<p>For the C compiler: I recommend gcc, but clang works as well.
The tutorial will be using gdb specific features so gdb is reqiured. Other C
debuggers like lldb will not work.</p>
<p>Once all of the system packages have been installed, run the following commands
in a terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git clone --recursive https://github.com/llllllllll/c-extension-tutorial.git
$ <span class="nb">cd</span> c-extension-tutorial
$ <span class="nb">source</span> etc/setup-env
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">setup-env</span></code> script will compile a debug version of CPython 3.6 and create
a local virtual env with this new interpreter. This ensures that everyone is
using the same version of CPython with the same compile time flags.</p>
<p>the <code class="docutils literal"><span class="pre">setup-env</span></code> should print a lot of stuff to the terminal. You can ignore
most of it but the last line should be:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Environment is setup correctly!
</pre></div>
</div>
</div>
<div class="section" id="viewing-the-tutorial">
<h2>Viewing the Tutorial<a class="headerlink" href="#viewing-the-tutorial" title="Permalink to this headline">¶</a></h2>
<p>The tutorial is structured as a sphinx project. This allows the tutorial to be
viewed from a standard browser or hosted online.</p>
<p>The material can be viewed in a browser by opening
<code class="docutils literal"><span class="pre">tutorial/build/html/index.html</span></code>, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="si">${</span><span class="nv">BROWSER</span><span class="si">}</span> tutorial/build/html/index.html
</pre></div>
</div>
</div>
<div class="section" id="install-steps-alternate">
<h2>Install Steps (Alternate)<a class="headerlink" href="#install-steps-alternate" title="Permalink to this headline">¶</a></h2>
<p>If you had significant difficulty getting your development environment set up
in the recommended manner (see above), you may prefer to try working in a
virtual machine.</p>
<p>First install Vagrant 1.9 and Virtualbox 5.1:</p>
<p><a class="reference external" href="https://www.vagrantup.com/downloads.html">https://www.vagrantup.com/downloads.html</a></p>
<p><a class="reference external" href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></p>
<p>Then run the following commands in your terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git clone --recursive https://github.com/llllllllll/c-extension-tutorial.git
$ <span class="nb">cd</span> c-extension-tutorial/etc
$ vagrant plugin install vagrant-vbguest
$ vagrant up --provider<span class="o">=</span>virtualbox
</pre></div>
</div>
<p>If all went well Vagrant will finish successfully with the message
&#8220;c_extension_tutorial VM provisioned successfully&#8221;. Be patient, it&#8217;ll
take a while to provision the VM. Don&#8217;t proceed until you see the success
message.</p>
<p>Vagrant should eventually bring up a Virtualbox GUI with a login
prompt. Log in with user <code class="docutils literal"><span class="pre">vagrant</span></code>, password <code class="docutils literal"><span class="pre">vagrant</span></code>. The
<code class="docutils literal"><span class="pre">c-extension-tutorial</span></code> directory is mounted at
<code class="docutils literal"><span class="pre">/home/vagrant/c-extension-tutorial</span></code>. You can build the project in
the VM by running the following commands in the VM terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/c-extension-tutorial
$ <span class="nb">source</span> etc/setup-env
</pre></div>
</div>
<p>Because <code class="docutils literal"><span class="pre">c-extension-tutorial</span></code> is a shared folder, you will see updates
propagate to your host folder. You can browse the documentation generated by
the VM build in your host machine&#8217;s web browser (see previous section).</p>
<p>If the vagrant-vbguest plugin fails to install you may be missing the Ruby
development files on your host machine. If you are running Windows you may
have additional difficulties. See:</p>
<p><a class="reference external" href="https://github.com/dotless-de/vagrant-vbguest">https://github.com/dotless-de/vagrant-vbguest</a></p>
<p>If for whatever reason you need to blow away your VM and start over, run the
following commands on your host machine:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> c-extension-tutorial/etc
$ vagrant destroy
</pre></div>
</div>
<div class="toctree-wrapper compound">
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="what-is-an-extension-module.html">What is an Extension Module?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="what-is-an-extension-module.html#why-write-an-extension-module">Why Write an Extension Module?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="c-level-representation.html">C Level Representation of Python Structures</a><ul>
<li class="toctree-l2"><a class="reference internal" href="c-level-representation.html#object-lifetime">Object Lifetime</a></li>
<li class="toctree-l2"><a class="reference internal" href="c-level-representation.html#concrete-types">Concrete Types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="writing-a-function.html">Writing a New Function in C</a><ul>
<li class="toctree-l2"><a class="reference internal" href="writing-a-function.html#pylongobject"><code class="docutils literal"><span class="pre">PyLongObject*</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-function.html#adapting-long-objects">Adapting Long Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-function.html#creating-a-python-callable-object">Creating a Python Callable Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-function.html#making-the-shared-object-importable">Making The Shared Object Importable</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building-and-importing.html">Building and Importing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="building-and-importing.html#compiling-the-module">Compiling the Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-and-importing.html#building">Building</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-and-importing.html#importing-and-using">Importing and Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-and-importing.html#invalid-arguments">Invalid Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="building-and-importing.html#why-did-this-hang">Why Did this Hang?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="error-handling.html">Error Handling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html#global-exception-indicator">Global Exception Indicator</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html#propagating-errors">Propagating Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html#raising-exceptions">Raising Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html#adding-error-handling-to-fib">Adding Error Handling to <code class="docutils literal"><span class="pre">fib</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="abstract-api.html">Abstract Object API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="abstract-api.html#generic-object-functions">Generic Object Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="abstract-api.html#number-protocol">Number Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="abstract-api.html#using-the-number-api-in-fib">Using the Number API in <code class="docutils literal"><span class="pre">fib</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="fancy-argument-parsing.html">Fancy Argument Parsing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="fancy-argument-parsing.html#type-conversion">Type Conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="fancy-argument-parsing.html#naming-our-function">Naming our Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="fancy-argument-parsing.html#optional-arguments">Optional Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="fancy-argument-parsing.html#keyword-only-arguments">Keyword Only Arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="fancy-argument-parsing.html#add-optional-arguments-a-and-b-to-fib">Add Optional Arguments <code class="docutils literal"><span class="pre">a</span></code> and <code class="docutils literal"><span class="pre">b</span></code> to <code class="docutils literal"><span class="pre">fib</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="writing-a-class.html">Writing a New Class in C</a><ul>
<li class="toctree-l2"><a class="reference internal" href="writing-a-class.html#instance-data">Instance Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-class.html#slots-without-a-python-equivalent">Slots Without a Python Equivalent</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-class.html#defining-a-pytypeobject">Defining a <code class="docutils literal"><span class="pre">PyTypeObject</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-class.html#readying-a-type">Readying a Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-a-class.html#implement-queue-push-and-queue-pop">Implement <code class="docutils literal"><span class="pre">Queue.push</span></code> and <code class="docutils literal"><span class="pre">Queue.pop</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="common-issues.html">Common Issues and Bugs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="common-issues.html#reference-counting-issues">Reference Counting Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gdb.html">Debugging with GDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#debugging-enabled-python">Debugging Enabled Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#general">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#setting-a-breakpoint">Setting a Breakpoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#running-the-program">Running the Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#interacting-with-the-program">Interacting with the Program</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#interacting-with-cpython">Interacting with CPython</a></li>
<li class="toctree-l2"><a class="reference internal" href="gdb.html#fix-queue-rotate">Fix <code class="docutils literal"><span class="pre">Queue.rotate</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="member-vs-getset.html"><code class="docutils literal"><span class="pre">PyMemberDef</span></code> vs <code class="docutils literal"><span class="pre">PyGetSetDef</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="member-vs-getset.html#pymemberdef"><code class="docutils literal"><span class="pre">PyMemberDef</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="member-vs-getset.html#pygetsetdef"><code class="docutils literal"><span class="pre">PyGetSetDef</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="member-vs-getset.html#expose-q-maxsize-to-python">Expose <code class="docutils literal"><span class="pre">q_maxsize</span></code> to Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#reference-counting">Reference Counting</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#cpython-types">CPython Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#global-sentinels">Global Sentinels</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#cpython-functions-and-macros">CPython Functions and Macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#number-api">Number API</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix.html#error-handling">Error Handling</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="what-is-an-extension-module.html" class="btn btn-neutral float-right" title="What is an Extension Module?" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Joe Jevnik.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>